<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" width="90%" height="90%" creationComplete="init()" >
	<mx:Script>
		<![CDATA[
			import mx.controls.Alert;
			import flash.net.NetConnection;
		
			public var sendTo:String;
			public var topic:String;
			public var chatManager:Chat;
			public var chatPanel:ChatPanel;
			
			public var defaultMessage:String;
			public var defaultFrom:String;
		
			public var chatRequest:Boolean = false;
			
			private function init():void {
				// todo
				
				if (defaultMessage != null) {
					addMessage(defaultFrom, defaultMessage);
				}
			}
			
			private function cleanUp():void {
				chatPanel.removeChatBox(this.topic);
			}
			
			public function keyEventHandler(event:KeyboardEvent):void {
				if (event.currentTarget == txtChatInput && event.keyCode == Keyboard.ENTER) {
					sendMessage();
				}
			}	
			
			public function sendMessage():void {
				
				var theMsg:String = txtChatInput.text;
				
				txtChatInput.text = "";
				
				if (chatRequest) {
					trace("about to send chat request");
					chatRequest = false;
					sendChatRequest(theMsg);
				} else {
					chatManager.publish(topic, sendTo, theMsg);
				}
				
			}		
			
			public function addMessage(from:String, theMsg:String):void {
				var formattedMsg:String = "<b>"+from+"</b>: " + theMsg;

				if (txaChatBoard != null) {
					txaChatBoard.htmlText += formattedMsg;
				} else {
					txaChatBoard.htmlText = formattedMsg;
				}
				
				callLater(setMaxVerticalScroll);
			}
			
			private function setMaxVerticalScroll():void {
				txaChatBoard.verticalScrollPosition = txaChatBoard.maxVerticalScrollPosition;				
			}
			
			private function sendChatRequest(theMsg:String):void {
				chatManager.sendChatRequest(sendTo, topic, theMsg);
			}
			
		]]>
	</mx:Script>
	<mx:TextArea width="100%" height="70%" editable="false" wordWrap="true" id="txaChatBoard"/>
	<mx:HBox width="100%">
		<mx:TextInput width="100%" id="txtChatInput" keyDown="keyEventHandler(event)"/>
		<mx:Button label="Send" id="btnChatSend" width="60" click="sendMessage()"/>
	</mx:HBox>
</mx:VBox>
