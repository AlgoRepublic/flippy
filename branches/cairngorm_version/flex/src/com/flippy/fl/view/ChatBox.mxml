<?xml version="1.0" encoding="utf-8"?>
<mx:VDividedBox xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" paddingLeft="5" paddingRight="5" paddingTop="5" paddingBottom="5" creationComplete="init()">
	<mx:Script>
		<![CDATA[
			import com.flippy.fl.events.ChatSendMessageEvent;
			import com.flippy.fl.events.ChatBroadcastEvent;
			import com.flippy.fl.model.Logger;
			import com.flippy.fl.model.Main;
			import com.flippy.fl.model.FlippyModelLocator;
			import mx.events.FlexEvent;
			import mx.controls.Alert;
		
			public var title:String;
			public var broadcast:Boolean;
			public var destUserName:String;
			
			public var chatPanel:ChatPanel;
			
			public var model:FlippyModelLocator = FlippyModelLocator.getInstance();
			public var main:Main = model.main;
			public var logger:Logger = model.logger;

			
			private function init():void {
			}
			
			public function keyEventHandler(event:KeyboardEvent):void {
				if (event.currentTarget == txtChatInput && event.keyCode == Keyboard.ENTER) {
					sendMessage();
				}
			}	
			
			public function sendMessage():void {
				// get message
				var theMsg:String = txtChatInput.text;

				// clear input				
				callLater(
					function doLater():void {
						txtChatInput.text = null;
						txtChatInput.htmlText = null;
					}
				);
				
				if (theMsg.length > 0) {	
					if (broadcast) {
						new ChatBroadcastEvent(main.sessionId, main.userName, theMsg, new Date()).dispatch();
					} else {
						new ChatSendMessageEvent(main.sessionId, main.userName,	destUserName, theMsg, new Date()).dispatch();
						onMessage(main.sessionId, main.userName, theMsg, new Date());
					} 
				}
				
			}								
			
			public function setInputFocus():void {
				txtChatInput.setFocus();
			}
			
			/** FROM SERVER **/
			public function onBroadcastMessage(sessionId:int, userName:String, msg:String, date:Date):void {
				txaChatBoard.htmlText += "<b>" + userName + ":</b> " + msg;
				txaChatBoard.verticalScrollPosition = txaChatBoard.maxVerticalScrollPosition;
				txaChatBoard.validateNow();
			}
			
			public function onMessage(sessionId:int, userName:String, msg:String, date:Date):void {
				txaChatBoard.htmlText += "<b>" + userName + ":</b> " + msg;
				txaChatBoard.verticalScrollPosition = txaChatBoard.maxVerticalScrollPosition;
				txaChatBoard.validateNow();
			}
			
		]]>
	</mx:Script>
	
	<mx:TextArea width="100%" height="70%" editable="false" wordWrap="true" id="txaChatBoard" minHeight="50" click="setInputFocus()"/>
	<mx:HBox width="100%" minHeight="50">
		<mx:TextArea width="100%" height="95%" id="txtChatInput" keyDown="keyEventHandler(event)" wordWrap="true" />
		<mx:Button label="Send" id="btnChatSend" width="60" click="sendMessage()"/>
	</mx:HBox>
	
</mx:VDividedBox>
